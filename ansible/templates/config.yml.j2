# SMTP Relay Configuration - Generated by Ansible
# {{ ansible_managed }}

smtp:
  listeners:
    - name: "legacy-plain"
      port: {{ smtp_port | default(2525) }}
      host: "0.0.0.0"
      auth:
        required: false
        enabled: false
      tls:
        enabled: false
        optional: true
    
    - name: "submission"
      port: {{ smtp_submission_port | default(2587) }}
      host: "0.0.0.0"
      auth:
        required: false
        enabled: true
        methods:
          - PLAIN
          - LOGIN
      tls:
        enabled: true
        starttls: true
        required: false
    
    - name: "smtps"
      port: {{ smtps_port | default(2465) }}
      host: "0.0.0.0"
      auth:
        required: false
        enabled: true
      tls:
        enabled: true
        implicit: true

tls:
  cert: "{{ app_dir }}/certs/cert.pem"
  key: "{{ app_dir }}/certs/key.pem"
  min_version: "TLSv1.2"
  ciphers: "HIGH:!aNULL:!MD5"

auth:
  ip_whitelist_enabled: true
  ip_whitelist:
{% for network in smtp_ip_whitelist | default(['192.168.0.0/16', '10.0.0.0/8']) %}
    - "{{ network }}"
{% endfor %}
  
  no_auth_required:
{% for network in smtp_no_auth_networks | default(['192.168.0.0/16', '10.0.0.0/8']) %}
    - "{{ network }}"
{% endfor %}

exchange_online:
  # API Method Selection
  method: "{{ exchange_api_method | default('graph_api') }}"  # graph_api, smtp_oauth2, or hybrid
  
  # For SMTP OAuth2 (legacy)
  host: "smtp.office365.com"
  port: 587
  
  # OAuth2 Authentication
  auth:
    method: "{{ exchange_auth_method | default('client_credentials') }}"
    tenant_id: "{{ exchange_tenant_id }}"
    client_id: "{{ exchange_client_id }}"
{% if exchange_client_secret is defined %}
    client_secret: "{{ exchange_client_secret }}"
{% endif %}
{% if exchange_send_as is defined %}
    send_as: "{{ exchange_send_as }}"
{% endif %}

relay:
  allowed_sender_domains:
{% for domain in allowed_sender_domains | default(['*']) %}
    - "{{ domain }}"
{% endfor %}
  
  allowed_recipient_domains:
{% for domain in allowed_recipient_domains | default(['*']) %}
    - "{{ domain }}"
{% endfor %}
  
  header_rewrite:
    add_message_id: true
    add_date: true
    add_received: true
    fix_from_address: true
  
  rate_limiting:
    enabled: {{ rate_limiting_enabled | default(true) }}
    max_messages_per_minute: {{ max_messages_per_minute | default(100) }}
    max_recipients_per_message: {{ max_recipients_per_message | default(100) }}

logging:
  level: "{{ log_level | default('info') }}"
  file: "{{ log_dir }}/smtp-relay.log"
  console: true
  format: "json"

monitoring:
  enabled: {{ monitoring_enabled | default(true) }}
  port: {{ monitoring_port | default(8080) }}
  metrics_enabled: true
  health_check_path: "/health"

queue:
  enabled: {{ queue_enabled | default(true) }}
  retry_attempts: {{ queue_retry_attempts | default(3) }}
  retry_delay: {{ queue_retry_delay | default(300) }}
  max_queue_size: {{ max_queue_size | default(1000) }}