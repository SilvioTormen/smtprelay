# Legacy SMTP Relay Configuration
# Copy this file to config.yml and adjust the settings

# Multi-Port SMTP Server f√ºr Legacy Ger√§te
smtp:
  listeners:
    # Port 25 - Alte Ger√§te ohne Auth/TLS
    - name: "legacy-plain"
      port: 25
      host: "0.0.0.0"
      auth:
        required: false  # Keine Auth f√ºr alte Drucker
        enabled: false
      tls:
        enabled: false   # Kein TLS f√ºr ganz alte Ger√§te
        optional: true   # Falls Ger√§t es unterst√ºtzt
    
    # Port 587 - Neuere Legacy Ger√§te mit STARTTLS
    - name: "submission"
      port: 587
      host: "0.0.0.0"
      auth:
        required: false  # Optional f√ºr Legacy
        enabled: true
        methods:
          - PLAIN
          - LOGIN
      tls:
        enabled: true
        starttls: true   # STARTTLS Support
        required: false  # Optional f√ºr Legacy
    
    # Port 465 - Alte Ger√§te mit Implicit SSL
    - name: "smtps"
      port: 465
      host: "0.0.0.0"
      auth:
        required: false
        enabled: true
      tls:
        enabled: true
        implicit: true   # Implicit TLS/SSL

# TLS Zertifikate (falls vorhanden)
tls:
  cert: "./certs/cert.pem"    # Optional: Self-signed f√ºr Legacy
  key: "./certs/key.pem"
  # F√ºr Legacy: Akzeptiere alte TLS Versionen
  min_version: "TLSv1.0"       # Legacy Support!
  ciphers: "DEFAULT"           # Alle Cipher f√ºr Kompatibilit√§t

# Legacy Ger√§te Authentifizierung
legacy_auth:
  # Einfache User/Pass f√ºr Ger√§te die Auth k√∂nnen
  # WICHTIG: Verwenden Sie starke, einzigartige Passw√∂rter!
  # Generieren Sie diese mit: openssl rand -base64 16
  static_users:
    - username: "drucker"
      password: "CHANGE_THIS_USE_STRONG_PASSWORD"  # Mindestens 16 Zeichen!
      allowed_ips: ["192.168.1.0/24"]
    - username: "scanner"  
      password: "CHANGE_THIS_USE_STRONG_PASSWORD"  # Eindeutiges Passwort!
      allowed_ips: ["192.168.1.0/24"]
    - username: "nas"
      password: "CHANGE_THIS_USE_STRONG_PASSWORD"  # Niemals Default-Passw√∂rter!
      allowed_ips: ["10.0.0.0/16"]

# IP-basierte Authentifizierung (wichtig f√ºr Legacy!)
ip_whitelist:
  # Ger√§te die OHNE Auth senden d√ºrfen
  no_auth_required:
    - "192.168.1.0/24"   # Drucker VLAN
    - "10.0.50.0/24"     # IoT/Legacy VLAN
    - "172.16.0.0/16"    # Alte Server
  
  # Komplett blockierte IPs
  blacklist: []

# Exchange Online Relay
exchange_online:
  # ========================================================================
  # WICHTIG: W√§hle deine API-Methode!
  # ========================================================================
  # method: "graph_api"     # ‚úÖ EMPFOHLEN - Moderne Graph API (kein SMTP Auth n√∂tig!)
  # method: "smtp_oauth2"   # ‚ö†Ô∏è Legacy - SMTP Protokoll (SMTP Auth muss aktiviert sein!)
  # method: "hybrid"        # üîÑ Beide - Automatischer Fallback
  
  method: "graph_api"  # EMPFOHLEN!
  
  # F√ºr Graph API (EMPFOHLEN):
  # - Azure AD Permission: "Mail.Send" von Microsoft Graph
  # - SMTP Auth am Postfach: NICHT n√∂tig!
  
  # F√ºr SMTP OAuth2 (Legacy):
  # - Azure AD Permission: "SMTP.Send" von Office 365 Exchange Online
  # - SMTP Auth am Postfach: MUSS aktiviert sein!
  host: "smtp.office365.com"  # Nur f√ºr smtp_oauth2 Methode
  port: 587                    # Nur f√ºr smtp_oauth2 Methode
  
  # OAuth2 Authentication (f√ºr beide Methoden):
  auth:
    method: "device_code"  # Options: device_code, authorization_code
    tenant_id: "your-tenant-id"  # Or "common" for multi-tenant
    client_id: "your-client-id"  # Azure AD App ID
    send_as: "relay@yourdomain.com"  # Optional: default sender
  
  # Option 2: Authorization Code Flow (For web dashboard)
  # Interactive browser-based authentication
  # auth:
  #   method: "authorization_code"
  #   tenant_id: "your-tenant-id"
  #   client_id: "your-client-id"
  #   client_secret: "your-client-secret"  # Optional for public clients
  #   redirect_uri: "http://localhost:3001/api/auth/callback"

# Relay Regeln
relay:
  # Von welchen Domains akzeptieren
  allowed_sender_domains:
    - "*"  # Alle internen Sender erlauben
  
  # An welche Domains weiterleiten
  allowed_recipient_domains:
    - "yourdomain.com"
    - "external-partner.com"
  
  # Header Rewriting f√ºr Legacy
  header_rewrite:
    # F√ºge fehlende Headers hinzu
    add_message_id: true
    add_date: true
    add_received: true
    # Korrigiere invalide From Adressen
    fix_from: true
    default_from: "noreply@yourdomain.com"

# Queue f√ºr Ausfallsicherheit
queue:
  enabled: true
  directory: "./queue"
  retry:
    max_attempts: 5
    delays: [60, 300, 900, 3600, 7200]  # Sekunden

# Logging
logging:
  level: "info"
  file: "/var/log/smtp-relay/relay.log"
  # Spezial-Logs f√ºr Legacy Debugging
  log_auth_failures: true
  log_tls_errors: true
  log_per_device: true  # Separate Logs per IP

# Rate Limiting (sanft f√ºr Legacy)
rate_limit:
  enabled: true
  # Gro√üz√ºgige Limits f√ºr Legacy
  per_ip: 1000        # Pro Stunde
  per_sender: 500     # Pro Stunde
  burst: 50           # Burst erlauben

# Legacy-spezifische Einstellungen
legacy:
  # Akzeptiere nicht-standard SMTP Commands
  relaxed_smtp: true
  # Akzeptiere 8-bit in Headers
  allow_8bit_headers: true
  # Gr√∂√üere Timeouts f√ºr langsame Ger√§te
  command_timeout: 300
  data_timeout: 600
  # Akzeptiere Mails ohne From
  allow_empty_from: true